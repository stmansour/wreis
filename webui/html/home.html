<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/html/fa/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/static/js/w2ui-1.5.rc1.min.css" />
    <link rel="icon" type="image/png" href="/static/html/images/favicon32x32.png">
</head>
<body>

<!--  color Icon images:  icon-page, w2ui-icon-check, ... see below in toptoolbar -->

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/w2ui-1.5.rc1.js"></script>
<script src="/static/js/login.js"></script>
<script>
/*global
    w2ui,$,console,
*/

/*globals $:false */

"use strict";

// The mojo app object. Used to manage app-level data.
var app = {
    lastReport: '',
    serverversion: '',
    protocolVersion: '1',
    language: "{{.Language}}",
    template: "{{.Template}}",
    pstyle: 'border: 1px solid #dfdfdf; padding: 0px;',
    pstyleNB: 'border: 0px solid #dfdfdf; padding: 0px;',
    pstyle4: 'border: 1px solid #bbbbbb; padding: 0px;',
    pstyle2: 'border: 1px solid #cfcfcf; padding: 0px;',
    pstylewhite: 'border:4px; solid #bbbbbb; background-color: white;',
    bgyellow: 'background-color: yellow;',
    stdfmt: 'font-family: "Open Sans","Roboto",sans-serif; font-size: 8pt; border: 1px solid #dfdfdf; border-spacing:0px; padding: 3px; color: #777777;',
    gid: 0, // last selected group id
    groupFilter: "",
};

function openInNewTab(url) {
    var win = window.open(url, '_blank');
    win.focus();
}

function defineDateFmts() {
    var month = (new Date()).getMonth() + 1;
    var year  = (new Date()).getFullYear();
    // // US Format
    $('input[type=us-date]').w2field('date',  { format: 'm/d/yyy' });
    $('input[type=us-dateA]').w2field('date', { format: 'm/d/yyyy', start:  month + '/5/' + year, end: month + '/25/' + year });
    $('input[type=us-dateB]').w2field('date', { format: 'm/d/yyyy', blocked: [ month+'/12/2014',month+'/13/2014',month+'/14/' + year,]});
    $('input[type=us-date1]').w2field('date', { format: 'm/d/yyyy', end: $('input[type=us-date2]') });
    $('input[type=us-date2]').w2field('date', { format: 'm/d/yyyy', start: $('input[type=us-date1]') });
    $('input[type=us-time]').w2field('time',  { format: 'h12' });
    $('input[type=us-timeA]').w2field('time', { format: 'h12', start: '8:00 am', end: '4:30 pm' });

    // EU Common Format
    $('input[type=eu-date]').w2field('date',  { format: 'd.m.yyyy' });
    $('input[type=eu-dateA]').w2field('date', { format: 'd.m.yyyy', start:  '5.' + month + '.' + year, end: '25.' + month + '.' + year });
    $('input[type=eu-dateB]').w2field('date', { format: 'd.m.yyyy', blocked: ['12.' + month + '.' + year, '13.' + month + '.' + year, '14.' + month + '.' + year]});
    $('input[type=eu-date1]').w2field('date', { format: 'd.m.yyyy', end: $('input[type=eu-date2]') });
    $('input[type=eu-date2]').w2field('date', { format: 'd.m.yyyy', start: $('input[type=eu-date1]') });
    $('input[type=eu-time]').w2field('time',  { format: 'h24' });
    $('input[type=eu-timeA]').w2field('time', { format: 'h24', start: '8:00 am', end: '4:30 pm' });
}

function initializePropertyRecord() {
    var rec = {
            recid: 0,
            PRID: 0,
            FirstName: '',
            MiddleName: '',
            LastName: '',
            PreferredName: '',
            JobTitle: '',
            OfficePhone: '',
            OfficeFax: '',
            Email1: '',
            Email2: '',
            MailAddress: '',
            MailAddress2: '',
            MailCity: '',
            MailState: '',
            MailPostalCode: '',
            MailCountry: '',
            RoomNumber: '',
            MailStop: '',
            Status: 0,
            OptOutDate: '12/31/3000',
            LastModTime: new Date(),
            LastModBy: 0
    };
    return rec;
}

//-----------------------------------------------------------------------------
// setToForm -  enable form sform in toplayout.  Also, set the forms url and
//              request data from the server
// @params
//   sform   = name of the form
//   url     = request URL for the form
//   [width] = optional, if specified it is the width of the form
//   doRequest =
//-----------------------------------------------------------------------------
function setToForm(sform, url, width) {
    if (url.length <= 0) {
        return false;
    }

    var f = w2ui[sform];
    if (!f) {
        return false;
    }

    // var g = w2ui[app.active_grid];
    // if (!g) {
    //     return false;
    // }

    f.url = url;
    if (typeof f.tabs != "undefined"){
        if (typeof f.tabs.name == "string") {
            f.tabs.click('tab1');
        }
    }

    f.reload();
    w2ui.toplayout.content('right', f);
    w2ui.toplayout.sizeTo('right', width);
    w2ui.toplayout.render();
    w2ui.toplayout.show('right', true);
}



// The reason to load these elements in this way rather than storing them as part of a
// 'config' variable then passing them into the widget generators is that we need to
// download the lists first. Making the elements part of a config.* variable would evaluate
// the dropdown lists prior to downloading their values. By doing it this way, we download
// the lists first so that their values will be set by the server before we build the UI.
function buildPageElements() {
    // "use strict";
    //------------------------------------------------------------------------
    //          mainlayout
    //------------------------------------------------------------------------
    $('#layout').w2layout({
        name: 'mainlayout',
        padding: 2,
        panels: [
            { type: 'top', size: 55, style: app.pstyle, content: 'top' },
            { type: 'left', size: 200, hidden: true, style: app.pstyle, content: 'left' },
            { type: 'main', style: app.pstyle, content: 'main' },
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: app.pstyle, content: 'preview' },
            { type: 'right', size: 200, resizable: true, style: app.pstyle, hidden: true, content: 'Details' },
            { type: 'bottom', size: 20, resizable: false, style: app.stdfmt, content: '&copy; 2015-2020 WREIS' }
        ]
    });


    //------------------------------------------------------------------------
    //          NEWS LAYOUT
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'newsLayout',
        padding: 0,
        panels: [
            { type: 'left', hidden: false, style: app.pstyleNB, size: 20 },
            { type: 'top', hidden: true },
            { type: 'main', size: '90%', resizable: true, hidden: false, style: app.pstyleNB, content: 'Hi.  I should load w2ui.newsLayout' },
            { type: 'preview', hidden: true },
            { type: 'bottom', hidden: true },
            { type: 'right', hidden: true }
        ]
    });

    //------------------------------------------------------------------------
    //          toplayout
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('main', $().w2layout({
        name: 'toplayout',
        padding: 2,
        panels: [
            { type: 'top',     size: 200, style: app.pstyle2,  hidden: true, resizable: true, content: w2ui.newsLayout},
            { type: 'left',    size: 200, style: app.pstyle2,                resizable: true, content: 'sidebar' },
            { type: 'main',               style: app.pstylewhite   },
            { type: 'preview', size: 0,   style: app.bgyellow, hidden: true, resizable: true, content: 'preview' },
            { type: 'right',   size: 400, style: app.pstyle2,  hidden: true, resizable: true, content: 'right' },
            { type: 'bottom',  size: 0,   style: app.pstyle2,  hidden: true, resizable: true, content: 'toplayout - bottom' }
        ]
    }));

    //------------------------------------------------------------------------
    //          toptoolbar
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('top', $().w2toolbar({
        name: 'toptoolbar',
        items: [
             { type: 'html',  id: 'logo',
                html: '<div style="padding: 4px 0px;">'+
                      '<img src="/static/html/images/logo.png">'+
                      '</div>'
            },
            { type: 'break', id: 'break1' },
            { type: 'menu',    id: 'moduleMenu', caption: 'Select Module',    icon: 'fa fa-sitemap', items: [
                { text: 'Directory',          icon: 'fa fa-user' },
            ]},
            { type: 'break', id: 'break2' },
            // { type: 'button', id: 'msgButton', caption: 'News Flash', icon: 'fa fa-spinner fa-pulse fa-3x fa-fw'},
            { type: 'menu',    id: 'menuButton', caption: 'Developer',    icon: 'fa fa-user-circle',
                    items: [ { text: 'Webdocs', icon: 'fa fa-book' }, ]},
            { id: 'bt3', type: 'spacer' },
            { type: 'menu',   id: 'userMenu',
                caption: '<div id="user_menu_container">'+
                      '<span id="username"></span>'+
                      '<img src="" />'+
                      '</div>',
                items: [
                    { id: 'Signout'  , text: 'Sign Out', icon: 'fa fa-sign-out' },
                ],
            },
            { id: 'help', text: 'Help', type: 'button', icon: 'fa fa-info-circle' },
        ],
        onClick: function (event) {
            console.log('target = ' + event.target);
            switch(event.target) {
                case "moduleMenu:Directory":
                    window.location.href = 'https://directory.airoller.com/';
                    break;
                case "moduleMenu:RentRoll":
                    window.location.href = 'https://localhost:8271/home/';
                    break;
                case "msgButton":
                    w2ui.toplayout.toggle('top',true);
                    w2ui.toplayout.set('top',{ content: w2ui.newsLayout});
                    w2ui.newsLayout.load('main', '/html/news.html', 'flip-down');
                    w2ui.toptoolbar.set('msgButton', {icon: 'fa fa-newspaper-o'});
                    break;
                case "menuButton:Webdocs": openInNewTab('/static/doc/docs.html'); break;
            }
        },
    }));

    //------------------------------------------------------------------------
    //          sidebarL1
    //------------------------------------------------------------------------
    w2ui.toplayout.content('left',$().w2sidebar({
        name: 'sidebarL1',
        nodes: [
            { id: 'view', text: 'View', img: 'icon-folder', expanded: true, group: true,
                nodes: [
                        { id: 'dashboard', text: 'Dashboard', icon: 'fa fa-tachometer' },
                        { id: 'property', text: 'Property', icon: 'fa fa-building' },
                ]
            },
            // { id: 'workflows', text: 'Workflows', img: 'icon-folder', expanded: true, group: true,
            //     nodes: [
            //             { id: 'sendml', text: 'Send Email To List', icon: 'fa fa-envelope-o' },
            //             { id: 'stats',  text: 'Statistics', icon: 'fa fa-bar-chart' },
            //     ]
            // },
            // { id: 'admin', text: 'Admin', img: 'icon-wrench', expanded: true, group: true,
            //     nodes: [
            //             { id: 'property', text: 'Show People', icon: 'fa fa-user'  },
            //             { id: 'groups', text: 'Show Groups', icon: 'fa fa-users' },
            //             { id: 'query',  text: 'Queries', icon: 'fa fa-list' },
            //     ]
            // },
        ],
        onClick: function (event) {
            var grid;
            console.log('event.target = ' + event.target);
            switch(event.target) {
                case 'dashboard':
                    w2ui.toplayout.load('main','/static/html/dashboard.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'property':
                    grid = event.target + 'Grid';
                    w2ui[grid].url = '/v' + app.protocolVersion + '/' + event.target + '/';
                    // console.log('url = ' + w2ui[grid].url);
                    w2ui.toplayout.content('main', w2ui[grid]);
                    w2ui.toplayout.hide('right',true);
                    break;
                // case 'groups':
                //     grid = event.target + 'Grid';
                //     w2ui[grid].url = '/v' + app.protocolVersion + '/' + event.target + '/';
                //     console.log('url = ' + w2ui[grid].url);
                //     w2ui.toplayout.content('main', w2ui[grid]);
                //     w2ui.toplayout.hide('right',true);
                //     break;
            }
        },
    }));

    // var oneShotGroupFilterELFlag = 0; // flag to set the event listener

    //------------------------------------------------------------------------
    //          propertyGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'propertyGrid',
        url: '/v1/property',
        show: {
            toolbar         : true,
            footer          : true,
            toolbarAdd      : true,   // indicates if toolbar add new button is visible
            toolbarDelete   : false,   // indicates if toolbar delete button is visible
            toolbarSave     : false,   // indicates if toolbar save button is visible
            selectColumn    : false,
            expandColumn    : false,
            toolbarEdit     : false,
            toolbarSearch   : false,
            toolbarInput    : true,
            searchAll       : false,
            toolbarReload   : true,
            toolbarColumns  : true,
        },
        //======================================================================
        // FLAGS
        //     1<<0  Drive Through?  0 = no, 1 = yes
        //	   1<<1  Roof & Structure Responsibility: 0 = Tenant, 1 = Landlord
        //	   1<<2  Right Of First Refusal: 0 = no, 1 = yes
        //======================================================================
         columns: [
            {field: 'PRID',                 size: '60px', sortable: true, hidden: true},
            {field: 'Recid',                size: '60px', sortable: true, hidden: true},
        	{field: 'PRID',                 size: '60px', sortable: true, hidden: true},
        	{field: 'Name',                 size: '200px', sortable: true, hidden: false},
        	{field: 'YearsInBusiness',      size: '60px', sortable: true, hidden: true},
        	{field: 'ParentCompany',        size: '60px', sortable: true, hidden: true},
        	{field: 'URL',                  size: '60px', sortable: true, hidden: true},
        	{field: 'Symbol',               size: '60px', sortable: true, hidden: true},
        	{field: 'Price',                size: '60px', sortable: true, hidden: true},
        	{field: 'DownPayment',          size: '60px', sortable: true, hidden: true},
        	{field: 'RentableArea',         size: '60px', sortable: true, hidden: true},
        	{field: 'RentableAreaUnits',    size: '60px', sortable: true, hidden: true},
        	{field: 'LotSize',              size: '60px', sortable: true, hidden: true},
        	{field: 'LotSizeUnits',         size: '60px', sortable: true, hidden: true},
        	{field: 'CapRate',              size: '60px', sortable: true, hidden: true},
        	{field: 'AvgCap',               size: '60px', sortable: true, hidden: true},
        	{field: 'BuildDate',            size: '60px', sortable: true, hidden: true},
        	{field: 'FLAGS',                size: '60px', sortable: true, hidden: true},
        	{field: 'Ownership',            size: '60px', sortable: true, hidden: true},
        	{field: 'TenantTradeName',      size: '60px', sortable: true, hidden: true},
        	{field: 'LeaseGuarantor',       size: '60px', sortable: true, hidden: true},
        	{field: 'LeaseType',            size: '60px', sortable: true, hidden: true},
        	{field: 'DeliveryDt',           size: '60px', sortable: true, hidden: true},
        	{field: 'OriginalLeaseTerm',    size: '60px', sortable: true, hidden: true},
        	{field: 'LeaseCommencementDt',  size: '60px', sortable: true, hidden: true},
        	{field: 'LeaseExpirationDt',    size: '60px', sortable: true, hidden: true},
        	{field: 'TermRemainingOnLease', size: '60px', sortable: true, hidden: true},
        	{field: 'ROLID',                size: '60px', sortable: true, hidden: true},
        	{field: 'RSLID',                size: '60px', sortable: true, hidden: true},
        	{field: 'Address',              size: '60px', sortable: true, hidden: true},
        	{field: 'Address2',             size: '60px', sortable: true, hidden: true},
        	{field: 'City',                 size: '100px', sortable: true, hidden: false},
        	{field: 'State',                size: '60px', sortable: true, hidden: false},
        	{field: 'PostalCode',           size: '60px', sortable: true, hidden: false},
        	{field: 'Country',              size: '60px', sortable: true, hidden: true},
        	{field: 'LLResponsibilities',   size: '60px', sortable: true, hidden: true},
        	{field: 'NOI',                  size: '60px', sortable: true, hidden: true},
        	{field: 'HQAddress',            size: '60px', sortable: true, hidden: true},
        	{field: 'HQAddress2',           size: '60px', sortable: true, hidden: true},
        	{field: 'HQCity',               size: '60px', sortable: true, hidden: true},
        	{field: 'HQState',              size: '60px', sortable: true, hidden: true},
        	{field: 'HQPostalCode',         size: '60px', sortable: true, hidden: true},
        	{field: 'HQCountry',            size: '60px', sortable: true, hidden: true},
            {field: 'CreateTime',           size: '60px', sortable: true, hidden: true},
            {field: 'CreatedBy',            size: '60px', sortable: true, hidden: true},
            {field: 'LastModTime',          size: '60px', sortable: true, hidden: true},
            {field: 'LastModBy',            size: '60px', sortable: true, hidden: true},
        ],
        onClick: function(event) {
            event.onComplete = function (event) {
                var rec = w2ui.propertyGrid.get(event.recid);
                //w2ui.propertyForm.record = initializePropertyRecord();
                w2ui.propertyForm.recid = rec.PRID;
                setToForm('propertyForm', '/v1/property/' + rec.PRID, 500);
            };
        },
        onRequest: function(event) {
            // Include any postData needed
            // w2ui.propertyGrid.postData = {groupName: app.groupFilter};
        },
        onAdd: function (/*event*/) {
            var f = w2ui.propertyForm;
            f.record = initializePropertyRecord();
            f.recid = 0;
            f.refresh();
            setToForm('propertyForm', '/v1/property/0',500);
        },
        onRefresh: function(/*event*/) {
            console.log('propertyGrid.onRefresh')
            //document.getElementById('mojoGroupFilter').value = app.groupFilter;
        },
        onLoad: function(/*event*/) {
            //document.getElementById('mojoGroupFilter').value = app.groupFilter;
        },
        onSearch: function(event) {
            console.log('onSearch event fired. event = ' + event);
        }
    });

    // w2ui.propertyGrid.toolbar.add(
    //     [
    //         { type: 'break', id: 'break1' },
    //         { type: 'html', id: 'groupName',
    //                 html: 'Group: <input type="text" id="mojoGroupFilter" value=""' +
    //                 'onkeypress="if (event.keyCode == 13) groupFilterSubmit();"' +
    //                 'value="'+app.groupFilter+'"'+
    //                 '>' },
    //     ],
    // );
    //
    // w2ui.propertyGrid.toolbar.on('refresh', function(event) {
    //     event.onComplete = function () {
    //         var x = document.getElementById('mojoGroupFilter');
    //         if (x != null) {
    //             x.value = app.groupFilter;
    //         }
    //     }
    // });

    //------------------------------------------------------------------------
    //          Property Form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'propertyForm',
        style: 'border: 0px; background-color: transparent;',
        header: 'Property Detail',
        url: '/v1/property',
        formURL: '/static/html/formproperty.html',
        fields: [
            {field: 'recid',                type: 'int',  required: false },
            {field: 'PRID',                 type: 'int',  required: false},
        	{field: 'Name',                 type: 'text', required: false},
        	{field: 'YearsInBusiness',      type: 'int',  required: false},
        	{field: 'ParentCompany',        type: 'text', required: false},
        	{field: 'URL',                  type: 'text', required: false},
        	{field: 'Symbol',               type: 'text',  required: false},
        	{field: 'Price',                type: 'money', required: false},
        	{field: 'DownPayment',          type: 'money', required: false},
        	{field: 'RentableArea',         type: 'int',   required: false},
        	{field: 'RentableAreaUnits',    type: 'text', required: false},
        	{field: 'LotSize',              type: 'int',  required: false},
        	{field: 'LotSizeUnits',         type: 'text', required: false},
        	{field: 'CapRate',              type: 'float', required: false},
        	{field: 'AvgCap',               type: 'float', required: false},
        	{field: 'BuildDate',            type: 'date', required: false},
        	{field: 'FLAGS',                type: 'text', required: false},
        	{field: 'Ownership',            type: 'text', required: false},
        	{field: 'TenantTradeName',      type: 'text', required: false},
        	{field: 'LeaseGuarantor',       type: 'text', required: false},
        	{field: 'LeaseType',            type: 'text', required: false},
        	{field: 'DeliveryDt',           type: 'date', required: false},
        	{field: 'OriginalLeaseTerm',    type: 'text', required: false},
        	{field: 'LeaseCommencementDt',  type: 'date', required: false},
        	{field: 'LeaseExpirationDt',    type: 'date', required: false},
        	{field: 'TermRemainingOnLease', type: 'text', required: false},
        	{field: 'ROLID',                type: 'int', required: false},
        	{field: 'RSLID',                type: 'int', required: false},
        	{field: 'Address',              type: 'text', required: false},
        	{field: 'Address2',             type: 'text', required: false},
        	{field: 'City',                 type: 'text', required: false},
        	{field: 'State',                type: 'text', required: false},
        	{field: 'PostalCode',           type: 'text', required: false},
        	{field: 'Country',              type: 'text', required: false},
        	{field: 'LLResponsibilities',   type: 'text', required: false},
        	{field: 'NOI',                  type: 'text', required: false},
        	{field: 'HQAddress',            type: 'text', required: false},
        	{field: 'HQAddress2',           type: 'text', required: false},
        	{field: 'HQCity',               type: 'text', required: false},
        	{field: 'HQState',              type: 'text', required: false},
        	{field: 'HQPostalCode',         type: 'text', required: false},
        	{field: 'HQCountry',            type: 'text', required: false},
            {field: 'CreateTime',           type: 'text', required: false},
            {field: 'CreatedBy',            type: 'text', required: false},
            {field: 'LastModTime',          type: 'text', required: false},
            {field: 'LastModBy',            type: 'text', required: false},
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                if (event.target == 'btnClose') {
                            w2ui.toplayout.hide('right',true);
                            w2ui.propertyGrid.render();
                }
            },
        },
        actions: {
            save: function () {
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.propertyGrid.reload();
                });

            },
            delete: function() {
                var request={cmd:"delete",selected: [w2ui.propertyForm.record.PRID]};
                $.post('/v1/person/'+w2ui.propertyForm.record.PRID, JSON.stringify(request))
                .done(function(data) {
                    if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                        var msg = JSON.parse(data);
                        w2ui.propertyForm.error(msg.message);
                        return;
                    }
                    if (data.status != 'success') {
                        w2ui.propertyForm.error(data.message);
                    }
                });
                w2ui.toplayout.hide('right',true);
                w2ui.propertyGrid.reload();
            },
            reset: function() {
                var f = w2ui.asmInstForm;
                console.log('reset: ASMID = ' + f.record.ASMID );
            }
        },
   });

    buildLoginForm();
}

function finishInitialization() {
    defineDateFmts();
    buildPageElements();
    launchSession();
}

// handleData is called with the return string from the ping command to the
// server. Handle any error encountered.  If no errors, proceed with bringing
// up the UI.
//------------------------------------------------------------------------------
function handleData(data,status) {
    if (status == "success") {
        if (data.substring(11,14) == "err") {
            console.log('ERROR: '+data);
        } else {
            app.serverversion = data;
        }
    } else {
        console.log( '**** YIPES! ****  status on /v1/ping/ = ' + status);
    }
    finishInitialization();
    w2ui.toplayout.load('main','/static/html/dashboard.html');
}

// Ping the server. Call a handler when data is received.
//------------------------------------------------------------------------------
$(function () {
    // $.get('/v1/ping/' + app.language + '/' + app.template)
    $.get('/v1/ping')
    .done(handleData)
    .fail( function() {
        console.log('Error getting /v1/ping');
     });
}
);

</script>

<div id="layout"style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>

</body>
</html>
